<!DOCTYPE html>
<html>
<head>
    <title>Agents Configuration</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<h1>‚öôÔ∏è Agents Configuration</h1>

<div id="config-container"></div>

<button id="saveBtn" class="save-btn">üíæ Save Configuration</button>

<div id="loadingOverlay" class="loading-overlay">
    <div class="spinner"></div>
</div>

<script>
    const configSections = [
        {
            title: "WhatsApp Settings",
            fields: [
                { key: "WHITELIST", label: "Whitelist (one per line)", type: "textarea" }
            ]
        },
        {
            title: "Agent Controls",
            id: "agent-controls",
            fields: [
                { key: "ENABLE_CLASSIFIER", label: "Classifier Agent", type: "toggle", readonly: true },
                { key: "ENABLE_API_AGENT", label: "API Agent", type: "toggle" },
                { key: "ENABLE_SQL_AGENT", label: "SQL Agent", type: "toggle" },
            ]
        },
        {
            title: "Manual Classifier Keywords",
            id: "classifier-keywords-section",
            fields: [
                { key: "SQL_KEYWORDS", label: "SQL Keywords (one per line)", type: "textarea" },
                { key: "API_KEYWORDS", label: "API Keywords (one per line)", type: "textarea" }
            ]
        },
        {
            title: "API Agent Settings",
            id: "api-agent-section",
            fields: [
                { key: "BASE_API_URL", label: "Base API URL", type: "text" },
                { key: "API_CUSTOM_HEADERS", label: "Custom Headers (Header: Value, one per line)", type: "textarea" }
            ]
        },
        {
            title: "SQL Agent Settings (Oracle)",
            id: "sql-agent-section",
            fields: [
                { key: "ORACLE_USER", label: "Oracle Username", type: "text" },
                { key: "ORACLE_PASSWORD", label: "Oracle Password", type: "password" },
                { key: "ORACLE_CONNECT_STRING", label: "Connection String", type: "text" }
            ]
        },
        {
            title: "LLM Provider API Keys",
            fields: [
                { key: "OPENAI_API_KEYS", label: "OpenAI API Keys (one per line)", type: "textarea" },
                { key: "GOOGLEAI_API_KEYS", label: "GoogleAI Keys (one per line)", type: "textarea" },
                { key: "OPENROUTER_API_KEYS", label: "OpenRouter Keys (one per line)", type: "textarea" },
                { key: "OPENROUTER_BASE_URL", label: "OpenRouter Base URL", type: "text" }
            ]
        },
        {
            title: "LLM Settings",
            fields: [
                { key: "LLM_LOCALE", label: "LLM Locale", type: "select", options: ["id-ID", "en-US", "zh-CN"] },
                { key: "MODEL_PRIORITY", label: "Model Priority (top = highest)", type: "textarea" }
            ]
        },
        {
            title: "LLM Embedding Settings",
            fields: [
                { key: "USE_EMBEDDING", label: "Enable Embedding", type: "toggle" },
                { key: "EMBEDDING_MODEL", label: "Embedding Model", type: "select", options: ["minilm", "gpt3s"] },
                { key: "EMBEDDING_LIMIT_SQL", label: "SQL Limit", type: "number" },
                { key: "EMBEDDING_LIMIT_SCHEMA", label: "Schema Limit", type: "number" },
                { key: "EMBEDDING_LIMIT_API", label: "API Limit", type: "number" }
            ]
        },
    ];

    async function loadConfig() {
        let data = {};
        try {
            const res = await fetch("/api/settings");
            const rows = await res.json();

            rows.forEach(r => {
                let value = r.value;
                if (r.type === "boolean") value = value === "true";
                else if (r.type === "number") value = Number(value);
                data[r.key] = value;
            });
        } catch (err) {
            console.error("Failed to load settings from API:", err);
            alert("Failed to load settings from API");
            return;
        }

        const container = document.getElementById("config-container");
        container.innerHTML = "";

        configSections.forEach(section => {
            const card = document.createElement("div");
            card.className = "config-card";
            card.dataset.sectionId = section.id || "";

            card.innerHTML = `
                <div class="config-header">
                    <h2>${section.title}</h2>
                    <span class="toggle">‚ñº</span>
                </div>
                <div class="config-body"></div>
            `;

            const body = card.querySelector(".config-body");

            section.fields.forEach(f => {
                const value = data[f.key] ?? "";
                let inputHtml = "";

                if (f.type === "toggle") {
                    inputHtml = `
                        <label class="switch">
                            <input type="checkbox" id="${f.key}" ${value ? "checked" : ""} ${f.readonly ? "disabled" : ""}>
                            <span class="slider"></span>
                        </label>
                    `;
                } else if (f.type === "select") {
                    inputHtml = `
                        <select id="${f.key}">
                            ${f.options.map(o => `<option value="${o}" ${o === value ? "selected" : ""}>${o}</option>`).join("")}
                        </select>
                    `;
                } else if (f.type === "textarea") {
                    inputHtml = `<textarea id="${f.key}" rows="3">${value}</textarea>`;
                } else {
                    inputHtml = `<input type="text" id="${f.key}" value="${value}" ${f.readonly ? "readonly" : ""}>`;
                }

                body.innerHTML += `
                    <div class="config-field">
                        <label>${f.label}</label>
                        ${inputHtml}
                    </div>
                `;
            });

            container.appendChild(card);
        });

        attachHandlers();
    }

    function attachHandlers() {
        document.querySelectorAll(".config-header").forEach(h => {
            h.addEventListener("click", () =>
                h.parentElement.classList.toggle("collapsed")
            );
        });

        document.getElementById("ENABLE_API_AGENT").addEventListener("change", handleAgentRules);
        document.getElementById("ENABLE_SQL_AGENT").addEventListener("change", handleAgentRules);

        handleAgentRules();
    }

    function handleAgentRules() {
        const apiOn = document.getElementById("ENABLE_API_AGENT").checked;
        const sqlOn = document.getElementById("ENABLE_SQL_AGENT").checked;

        const classifierEl = document.getElementById("ENABLE_CLASSIFIER");

        if (apiOn && sqlOn) {
            classifierEl.checked = true;
            classifierEl.disabled = false;
        } else {
            classifierEl.checked = false;
            classifierEl.disabled = true;
        }

        document.querySelector("[data-section-id='api-agent-section']").style.display = apiOn ? "block" : "none";
        document.querySelector("[data-section-id='sql-agent-section']").style.display = sqlOn ? "block" : "none";
    }

    document.getElementById("saveBtn").addEventListener("click", async () => {
        const overlay = document.getElementById("loadingOverlay");
        overlay.style.display = "flex"; // show loading

        const payload = {};
        document.querySelectorAll("#config-container input, select, textarea").forEach(el => {
            let value;
            if (el.type === "checkbox") value = el.checked ? "true" : "false";
                else if (el.type === "number") value = el.value;
                    else value = el.value ?? "";
            payload[el.id] = value;
        });

        try {
            const res = await fetch("/api/settings", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });

            const data = await res.json();
            if (data.success) alert("Configuration saved successfully!");
                else alert("Failed to save configuration");

        } catch (err) {
            console.error(err);
            alert("Error saving configuration");
        } finally {
            overlay.style.display = "none"; // hide loading
        }
    });

    loadConfig();
</script>

</body>
</html>

